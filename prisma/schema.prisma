// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// USER & AUTHENTICATION 
// ===========================================

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String? // Nullable for OAuth users
  fullName String?
  role     UserRole @default(STUDENT)

  // Profile
  profileColor String @default("#3B82F6") // Hex color for avatar

  // OAuth
  googleId String? @unique

  // Email verification (4 digit code)
  isEmailVerified          Boolean   @default(false)
  emailVerificationCode    String? // 4-digit code
  emailVerificationExpires DateTime?

  // Password reset
  passwordResetCode    String?
  passwordResetExpires DateTime?

  // User preferences (from Edit Profile screen)
  targetExamDate DateTime?
  dailyStudyGoal Int       @default(2) // Hours per day
  focusSubjects  String[] // Array of subject IDs user wants to focus on

  verificationFailedAttempts Int       @default(0)
  verificationLockedUntil    DateTime?

  // Onboarding tracking
  hasCompletedOnboarding Boolean   @default(false)
  onboardingSkipped      Boolean   @default(false)
  onboardingCompletedAt  DateTime?

  // Preferences (from Preferences screen)
  emailReminders         Boolean @default(true)
  studyStreakAlerts      Boolean @default(true)
  podcastRecommendations Boolean @default(true)
  showRelevantEpisodes   Boolean @default(true)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  subscription  Subscription?
  payments      Payment[]
  timedSessions TimedSession[]
  aiEvaluations AIEvaluation[]
  studyLogs     StudyLog[]
  savedCases    SavedCase[]
  quizAttempts  QuizAttempt[]
  achievements  UserAchievement[]

  subjectProgress  UserSubjectProgress[]
  moduleProgress   UserModuleProgress[]
  lessonProgress   UserLessonProgress[]
  questionAttempts QuestionAttempt[]
  studySessions    StudySession[]
  podcastProgress  UserPodcastProgress[]

  @@index([email])
  @@index([googleId])
  @@index([createdAt])
  @@index([hasCompletedOnboarding])
  @@map("users")
}

enum UserRole {
  STUDENT
  HOST
  ADMIN
}

// ============================================
// SUBSCRIPTION & PAYMENTS
// ============================================

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status   SubscriptionStatus
  planType PlanType? // Nullable for TRIAL

  // Stripe fields
  stripeCustomerId     String? // Stripe Customer ID
  stripeSubscriptionId String? @unique
  stripePriceId        String? // Price ID for the plan

  // Dates
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  trialEndsAt        DateTime?
  cancelledAt        DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payments Payment[]

  @@index([status])
  @@index([currentPeriodEnd])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model Payment {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  amount   Int // In cents 
  currency String        @default("EUR")
  status   PaymentStatus

  // Stripe fields
  stripePaymentIntentId String  @unique
  stripeInvoiceId       String?
  paymentMethod         String? // card, sepa_debit, etc.
  metadata              Json? // Store extra Stripe data

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
  @@map("payments")
}

model ExamSitting {
  id                   String    @id @default(cuid())
  name                 String // "April 2025 FE-1 Sitting"
  examDate             DateTime // Official exam start date
  registrationDeadline DateTime? // Last day to register
  resultsDate          DateTime? // When results are published
  isActive             Boolean   @default(true) // Current/upcoming sitting

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([examDate])
  @@index([isActive])
  @@map("exam_sittings")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum PlanType {
  MONTHLY
  ANNUAL
}

enum PaymentStatus {
  SUCCESS
  FAILED
  PENDING
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

model TimedSession {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  startedAt   DateTime      @default(now())
  submittedAt DateTime?
  duration    Int? // Time taken in seconds
  answerText  String?       @db.Text
  wordCount   Int?
  status      SessionStatus @default(IN_PROGRESS)
  autoSaved   Json? // Auto-save data

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  aiEvaluation AIEvaluation?

  @@index([userId])
  @@index([questionId])
  @@index([status])
  @@index([userId, status])
  @@index([createdAt])
  @@map("timed_sessions")
}

enum SessionStatus {
  IN_PROGRESS
  SUBMITTED
  ABANDONED
}

model QuizAttempt {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  selectedAnswer String // User's selected option
  isCorrect      Boolean
  timeSpent      Int // In seconds

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([questionId])
  @@index([isCorrect])
  @@index([userId, createdAt])
  @@map("quiz_attempts")
}

model AIEvaluation {
  id         String       @id @default(cuid())
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId  String       @unique
  session    TimedSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questionId String
  question   Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)

  feedback     Json // Structured feedback
  score        Int // 0-100
  strengths    String[] // What student did well
  improvements String[] // What to improve
  iracAnalysis Json? // Issue, Rule, Application, Conclusion

  // AI Provider details
  provider   String // "openai" or "anthropic"
  model      String // "gpt-4", "claude-3-5-sonnet"
  tokensUsed Int

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([questionId])
  @@index([provider])
  @@index([createdAt])
  @@map("ai_evaluations")
}

model CaseBrief {
  id       String @id @default(cuid())
  caseName String // "Donoghue v Stevenson"
  citation String // "[1932] AC 562"
  year     Int
  court    String // "House of Lords"

  facts        String @db.Text
  issue        String @db.Text
  ruling       String @db.Text
  reasoning    String @db.Text
  significance String @db.Text

  subjects String[] // Related subject IDs (no relation - just array)

  // For AI search
  embedding Json? // Vector embedding (optional)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  savedBy SavedCase[]

  @@index([year])
  @@index([caseName])
  @@index([citation])
  @@map("case_briefs")
}

model SavedCase {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  caseBriefId String
  caseBrief   CaseBrief @relation(fields: [caseBriefId], references: [id], onDelete: Cascade)

  lastReviewedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([userId, caseBriefId])
  @@index([userId])
  @@index([caseBriefId])
  @@map("saved_cases")
}

model StudyLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  activityType ActivityType
  resourceId   String? // ID of lesson/question/case
  resourceType String? // "LESSON", "QUESTION", "CASE"
  duration     Int // Time spent in seconds
  completedAt  DateTime?
  metadata     Json? // Extra data

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([activityType])
  @@index([userId, createdAt])
  @@index([userId, activityType])
  @@map("study_logs")
}

enum ActivityType {
  LESSON_VIEW
  LESSON_COMPLETE
  QUIZ_ATTEMPT
  ESSAY_PRACTICE
  CASE_REVIEW
  PODCAST_LISTEN
}

model Achievement {
  id          String          @id @default(cuid())
  title       String // "First Lesson Completed"
  description String
  type        AchievementType
  condition   Json // Condition to unlock (e.g., {"lessons": 1})
  icon        String? // Icon name or URL

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  userAchievements UserAchievement[]

  @@index([type])
  @@map("achievements")
}

enum AchievementType {
  LESSON_MILESTONE
  STREAK_MILESTONE
  QUIZ_ACCURACY
  EXAM_SIMULATION
  SUBJECT_MASTERY
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  unlockedAt DateTime @default(now())

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@map("user_achievements")
}

model Announcement {
  id          String           @id @default(cuid())
  title       String
  message     String           @db.Text
  type        AnnouncementType @default(INFO)
  targetRole  String           @default("ALL") // ALL, STUDENT, HOST
  isPublished Boolean          @default(false)
  publishedAt DateTime?
  expiresAt   DateTime?
  createdBy   String // User ID of host/admin

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isPublished])
  @@index([targetRole])
  @@index([expiresAt])
  @@index([isPublished, targetRole])
  @@map("announcements")
}

enum AnnouncementType {
  INFO
  WARNING
  URGENT
}

model UserPodcastProgress {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  podcastId String
  podcast   Podcast @relation(fields: [podcastId], references: [id], onDelete: Cascade)

  isCompleted     Boolean   @default(false)
  listenedSeconds Int       @default(0)
  completedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, podcastId])
  @@map("user_podcast_progress")
}

model Podcast {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text
  subject     String? // Related subject
  audioUrl    String // Cloudinary URL
  publicId    String // Cloudinary public_id
  duration    Int? // Duration in seconds
  thumbnail   String? // Cover image URL

  order       Int     @default(0)
  isPublished Boolean @default(true)

  progress UserPodcastProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("podcasts")
}

model StudySession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  moduleId  String?
  module    Module?  @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  lessonId  String?

  sessionType String?
  isActive    Boolean   @default(true)
  lastPingAt  DateTime?

  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationSeconds Int       @default(0)

  lessonsCompleted   Int     @default(0)
  questionsAttempted Int     @default(0)
  pointsEarned       Int     @default(0)
  notes              String?

  createdAt DateTime @default(now())

  @@map("study_sessions")
}

model UserLessonProgress {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  isCompleted         Boolean   @default(false)
  videoWatchedSeconds Int       @default(0)
  completedAt         DateTime?
  timeSpentSeconds    Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
  @@map("user_lesson_progress")
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model UserModuleProgress {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  progressPercent  Float          @default(0) // 0-100
  status           ProgressStatus @default(NOT_STARTED)
  completedLessons Int            @default(0)
  totalLessons     Int            @default(0) // Cached for performance
  lastAccessedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, moduleId])
  @@map("user_module_progress")
}

model UserSubjectProgress {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  progressPercent  Float          @default(0) // 0-100
  status           ProgressStatus @default(NOT_STARTED)
  totalTimeSeconds Int            @default(0)
  lastAccessedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, subjectId])
  @@map("user_subject_progress")
}

model Subject {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String? @db.Text
  icon        String? // Icon identifier
  order       Int // Display order
  isPublished Boolean @default(true)

  modules      Module[]
  userProgress UserSubjectProgress[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  studySessions StudySession[]

  @@map("subjects")
}

model Module {
  id        String  @id @default(cuid())
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  name        String
  slug        String
  description String? @db.Text
  order       Int // Display order within subject
  isPublished Boolean @default(true)

  lessons      Lesson[]
  questions    Question[] // Module-level questions
  userProgress UserModuleProgress[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  studySessions StudySession[]

  @@unique([subjectId, slug])
  @@map("modules")
}

model Lesson {
  id       String @id @default(cuid())
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title      String
  slug       String
  content    String  @db.Text // Rich text/markdown
  transcript String? @db.Text // Video transcript
  order      Int // Display order within module

  // Video details
  videoUrl      String?
  videoPublicId String? // Cloudinary public_id for deletion
  videoDuration Int? // Duration in seconds

  isPublished Boolean @default(true)

  // Relations
  assets       LessonAsset[]
  userProgress UserLessonProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([moduleId, slug])
  @@map("lessons")
}

model LessonAsset {
  id       String @id @default(cuid())
  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  type     AssetType
  title    String
  url      String // Cloudinary/S3 URL
  publicId String // For deletion
  fileSize Int? // In bytes
  mimeType String?
  duration Int? // For audio/video (seconds)

  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("lesson_assets")
}

enum AssetType {
  VIDEO
  PDF
  AUDIO
  IMAGE
}

model Question {
  id       String  @id @default(cuid())
  moduleId String? // Questions belong to modules
  module   Module? @relation(fields: [moduleId], references: [id], onDelete: SetNull)

  type          QuestionType
  text          String       @db.Text
  options       Json? // For MCQ: ["A: ...", "B: ...", "C: ...", "D: ..."]
  correctAnswer String? // For MCQ: "A"
  explanation   String?      @db.Text
  points        Int          @default(1)

  // For past questions
  year     Int?
  subject  String?
  examType String? // "Essay", "Problem", "MCQ"

  order       Int     @default(0)
  isPublished Boolean @default(true)

  // Relations - ADD THESE 3 LINES:
  timedSessions TimedSession[]
  quizAttempts  QuizAttempt[]
  aiEvaluations AIEvaluation[]
  attempts      QuestionAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("questions")
}

enum QuestionType {
  MCQ
  ESSAY
}

model QuestionAttempt {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  answer       String   @db.Text
  isCorrect    Boolean? // For MCQ
  pointsEarned Int      @default(0)

  // AI Grading (for essays)
  aiScore          Float? // 0-100
  knowledgeScore   Float? // Out of 30
  authoritiesScore Float? // Out of 25
  applicationScore Float? // Out of 25
  analysisScore    Float? // Out of 15
  structureScore   Float? // Out of 5
  band             String? // "70-79% Upper Second"
  appPass          Boolean? // true if >= 80%
  aiFeedback       String?  @db.Text
  strengths        Json? // Array of strings
  improvements     Json? // Array of strings
  nextSteps        String?  @db.Text

  timeTakenSeconds Int?

  createdAt DateTime @default(now())

  @@map("question_attempts")
}


enum CaseJurisdiction {
  IRISH_SUPREME_COURT
  IRISH_COURT_OF_APPEAL
  IRISH_HIGH_COURT
  UK_SUPREME_COURT
  UK_COURT_OF_APPEAL
  UK_HOUSE_OF_LORDS
  ECJ_CJEU
  ECHR
}

enum CaseFrequency {
  HIGH_FREQUENCY      
  MEDIUM_FREQUENCY    
  RARE                
  NOT_EXAMINED        
}